<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>FFF Farm Fight Formula</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><style>:root{--bg:#0b1020;--panel:#101833;--panel2:#0f1430;--accent:#7cc4ff;--accent2:#ffd166;--good:#4ade80;--bad:#fb7185;--mid:#a5b4fc;--card:#141d3f;--card2:#1a2454;--text:#e6e9ff;--muted:#a7b0d9}*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:radial-gradient(1200px 700px at 20% 0%,#0e1340 0%,var(--bg) 60%);color:var(--text)}h1{margin:0 0 12px;font-size:clamp(22px,4vw,36px);letter-spacing:.5px}.wrap{max-width:1200px;margin:0 auto;padding:16px}.sub{color:var(--muted);margin-bottom:18px}.btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(180deg,#2a3c7e,#1b2a5b);color:#fff;font-weight:700;letter-spacing:.3px;box-shadow:0 6px 14px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.08)}.btn-ghost{cursor:pointer;border:1px solid #2b3a86;background:#0c1230;color:#cfe3ff;border-radius:10px;padding:8px 10px}.hud{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;margin-bottom:12px}.meter{display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #243069;border-radius:14px;padding:8px 10px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03)}.meter b{font-size:14px;color:var(--muted)}.meter .value{font-size:18px}.meter .bar{flex:1;max-width:140px;height:6px;background:#243069;border-radius:3px;overflow:visible;margin-left:6px}.meter .bar .fill{height:100%;width:0;background:linear-gradient(90deg,var(--good),var(--accent));transition:width .25s ease}.meter.mana .fill{background:linear-gradient(90deg,var(--accent2),var(--accent))}.meter.enemy .fill{background:linear-gradient(90deg,var(--bad),var(--accent2))}
/* ensure enemy hp bar has room */
.meter.enemy{min-width:280px}
.meter.enemy .bar{min-width:140px}.center-hud{display:flex;gap:8px;align-items:center}.zone-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:6px 0 2px}.board{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));border-radius:16px;padding:20px 12px;min-height:200px;border:1px dashed #31408b;position:relative;overflow:visible;margin:24px 0}.hand{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;margin:24px 0 48px}.card{width:176px;aspect-ratio:auto;min-height:240px;background:linear-gradient(180deg,var(--card2),var(--card));border-radius:18px;border:1px solid #28336b;box-shadow:0 10px 20px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.06);padding:8px;display:grid;grid-template-rows:auto auto minmax(78px,1fr) auto auto;row-gap:6px;position:relative;user-select:none;transition:transform .18s ease,box-shadow .18s ease;overflow:visible;transform-style:preserve-3d;--mx:50%;--my:50%;--rX:0deg;--rY:0deg}.card .head{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;margin-bottom:2px}.card .head .name{min-width:0}.cost{display:grid;place-items:center;width:22px;height:22px;border-radius:50%;font-weight:900;color:#02122e;background:radial-gradient(circle at 30% 30%,#aee5ff,#4aa3ff);box-shadow:0 8px 14px rgba(74,163,255,.35),inset 0 0 18px rgba(255,255,255,.35)}.name{font-weight:800;font-size:14px;line-height:1.15;white-space:normal;overflow:visible;text-overflow:clip;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.badge{font-size:10px;padding:3px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.14)}.badge.atk{background:linear-gradient(180deg,#1f2a64,#15204a)}.badge.def{background:linear-gradient(180deg,#2a5f3a,#1e462b)}.tribe{font-size:12px;color:var(--muted)}.art{display:flex;align-items:center;justify-content:center;min-height:88px;height:auto;font-size:48px}.text{font-size:12px;color:#d9e3ff;background:#0e1435;border:1px solid #25306a;border-radius:10px;padding:6px;margin:0;max-width:100%;word-break:break-word;box-sizing:border-box}.stats{display:flex;justify-content:space-between;align-items:center;margin:0;min-height:26px;align-self:end}.gem{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.08)}.atk{background:linear-gradient(180deg,#233b7a,#1a2f66)}.hp{background:linear-gradient(180deg,#2a5f3a,#1e462b)}.hp.low{background:linear-gradient(180deg,#7a2e36,#5a1f25)}.keyword{display:inline-block;background:linear-gradient(180deg,#6342b6,#3b1f7e);padding:2px 6px;border-radius:999px;font-size:11px;margin-right:6px;border:1px solid rgba(255,255,255,.12)}.selectable{outline:2px solid rgba(124,196,255,.8);box-shadow:0 0 0 6px rgba(124,196,255,.2)}.card.blocked{border-color:#7a2230;box-shadow:0 0 0 3px rgba(251,113,133,.2) inset,0 8px 18px rgba(122,34,48,.25);cursor:not-allowed}.card .bg{position:absolute;inset:0;border-radius:18px;background:radial-gradient(140% 100% at 50% 0%,rgba(255,255,255,.04),rgba(0,0,0,0));z-index:0;transform:translate3d(0,0,0) scale(1.02);transition:transform .15s ease}.card>*:not(.bg){position:relative;z-index:1}#playerBoard .card:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 16px 30px rgba(0,0,0,.45),0 0 0 2px rgba(124,196,255,.15) inset}.card.tilted{transform:rotateX(var(--rX)) rotateY(var(--rY)) scale(1.03)}.card::before{content:"";position:absolute;inset:-1px;border-radius:inherit;background:conic-gradient(from 0deg at var(--mx) var(--my), #7cc4ff66, #ffd16666, #a5b4fc66, #4ade8066, #fb718566, #7cc4ff66);filter:blur(10px) saturate(1.05);mix-blend-mode:color-dodge;opacity:0;transition:opacity .2s ease}.card::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(180px 180px at var(--mx) var(--my), rgba(255,255,255,.18), transparent 40%);opacity:0;transition:opacity .2s ease}.card.tilted::before{opacity:.28}.card.tilted::after{opacity:.22}.card.attack-lunge{animation:lunge .35s ease}.card.hit-shake{animation:shakeHit .35s ease}.card.shield-flash{animation:shieldFlash .6s ease}@keyframes lunge{0%{transform:translateZ(0)}35%{transform:translate(6px,-8px) scale(1.04)}100%{transform:translateZ(0)}}@keyframes shakeHit{0%,100%{transform:translateZ(0)}20%{transform:translate(-2px,0)}40%{transform:translate(3px,-1px)}60%{transform:translate(-3px,1px)}80%{transform:translate(2px,-1px)}}@keyframes shieldFlash{0%{box-shadow:0 0 0 0 rgba(76,175,80,0),0 0 0 0 rgba(124,196,255,0)}30%{box-shadow:0 0 0 3px rgba(76,175,80,.35),0 0 18px 6px rgba(124,196,255,.2)}100%{box-shadow:0 0 0 0 rgba(76,175,80,0),0 0 0 0 rgba(124,196,255,0)}}.fx{position:fixed;z-index:1200;left:0;top:0;transform:translate(-50%,-50%);pointer-events:none}.fx.fx-slash{width:140px;height:8px;border-radius:999px;background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.95),rgba(255,255,255,0));transform-origin:left center;opacity:0;animation:slashIn .35s ease forwards}@keyframes slashIn{0%{opacity:0;transform:scaleX(0) rotate(var(--ang,0deg))}20%{opacity:1}100%{opacity:0;transform:scaleX(1) rotate(var(--ang,0deg))}}.fx-float{position:fixed;z-index:1300;left:0;top:0;transform:translate(-50%,-50%);font-weight:900;font-size:18px;opacity:0;text-shadow:0 2px 10px rgba(0,0,0,.6);animation:floatUp .9s ease-out forwards}.fx-float.heal{color:#8bf5a2}.fx-float.buff{color:#ffd166}.fx-float.dmg{color:#ff8a8a}@keyframes floatUp{0%{opacity:0;transform:translate(-50%,-10px) scale(.9)}25%{opacity:1}100%{opacity:0;transform:translate(-50%,-70px) scale(1)}}
.enemy-img{display:inline-grid;place-items:center;width:28px;height:28px;margin-left:8px;border-radius:50%;border:1px solid #2b3a86;background:linear-gradient(180deg,#0e1636,#0a1027);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}.start{position:fixed;inset:0;display:grid;place-items:center;z-index:5;background:radial-gradient(1200px 700px at 80% 20%,#10236a 0%,#0b1020 60%)}.start .panel{position:relative;background:linear-gradient(180deg,#121a44,#0c1230);border:1px solid #2b3a86;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.5);padding:26px 28px;max-width:980px;width:min(94vw,980px)}.brand{display:flex;align-items:center;gap:10px}.logoFFF{width:36px;height:36px}.deckpick{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px;margin:14px 0}.deckbtn{position:relative;display:flex;flex-direction:column;gap:4px;align-items:flex-start;justify-content:center;overflow:visible}.deckbtn::before{content:"";position:absolute;inset:-2px;border-radius:12px;background:conic-gradient(from 0deg at var(--px,50%) var(--py,50%),#7cc4ff,#ffd166,#a5b4fc,#4ade80,#fb7185,#7cc4ff);filter:blur(8px) saturate(1.1);opacity:var(--halo,0);transition:opacity .25s ease;pointer-events:none;z-index:0}.deckbtn::after{content:"";position:absolute;inset:0;border-radius:12px;background:radial-gradient(160px 160px at var(--px,50%) var(--py,50%),rgba(255,255,255,.18),transparent 40%);opacity:var(--shine,0);transition:opacity .25s ease;pointer-events:none;z-index:0}.deckbtn>*{position:relative;z-index:1}.ribbon{font-size:12px;color:var(--muted)}.view-cards{position:absolute;right:12px;bottom:12px;display:inline-grid;place-items:center;font-size:18px;color:#cfe3ff;cursor:pointer;z-index:2;background:none;border:0;box-shadow:none;width:auto;height:auto;padding:0}.view-cards[data-tip]::after{content:attr(data-tip);position:absolute;right:0;bottom:100%;transform:translateY(-8px);background:#0e1435;border:1px solid #2b3a86;border-radius:10px;padding:8px 10px;box-shadow:0 12px 30px rgba(0,0,0,.45);opacity:0;white-space:nowrap}.view-cards:hover::after{opacity:1}.footer{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}.log{max-height:160px;overflow:auto;background:linear-gradient(180deg,#0e1331,#0a0f27);border:1px solid #243069;border-radius:12px;padding:8px;font-size:13px;color:#c9d2ff}.pile{display:grid;place-items:center;width:66px;height:94px;border-radius:10px;border:1px dashed #31408b;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));position:relative}.pile .count{position:absolute;right:6px;bottom:6px;font-weight:800;background:#0e1435;border:1px solid #25306a;border-radius:12px;padding:2px 6px;font-size:12px}.tray{display:flex;gap:12px;align-items:center;margin:6px 0}.tray .spacer{flex:1}.end-overlay{position:fixed;inset:0;display:none;place-items:center;background:radial-gradient(800px 400px at 50% 50%,rgba(255,255,255,.06),rgba(0,0,0,.8));z-index:2000}.end-overlay.show{display:grid}.end-msg{font-size:56px;font-weight:900;letter-spacing:1px;text-shadow:0 8px 40px rgba(0,0,0,.6)}.end-box{background:linear-gradient(180deg,#121a44,#0c1230);border:1px solid #2b3a86;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.5);padding:22px 26px;display:flex;flex-direction:column;gap:12px;align-items:center;opacity:0;transform:translateY(6px);transition:opacity .3s ease .15s,transform .3s ease .15s}.end-overlay.show .end-box{opacity:1;transform:none}.end-actions{display:flex;gap:10px;justify-content:center;opacity:0;transform:translateY(6px);transition:opacity .35s ease .75s,transform .35s ease .75s}.end-overlay.show .end-actions{opacity:1;transform:none}.end-sub{color:var(--muted);font-size:14px;opacity:0;transform:translateY(6px);transition:opacity .35s ease .6s,transform .35s ease .6s}.end-overlay.show .end-sub{opacity:1;transform:none}.end-msg{opacity:0;transform:translateY(6px);transition:opacity .35s ease .45s,transform .35s ease .45s}.end-overlay.show .end-msg{opacity:1;transform:none}.boom{position:fixed;inset:0;pointer-events:none;background:radial-gradient(circle at 50% 50%,rgba(255,255,255,.9),rgba(255,255,255,0));opacity:0;animation:boom .6s ease-out forwards}@keyframes boom{0%{opacity:.95;transform:scale(.8)}100%{opacity:0;transform:scale(1.6)}}.ency{position:fixed;inset:0;padding:32px;z-index:1200;display:none;place-items:center;background:radial-gradient(1200px 700px at 80% 20%,#10236a 0%,#0b1020 60%)}.ency.show{display:grid}.ency .panel{background:linear-gradient(180deg,#121a44,#0c1230);border:1px solid #2b3a86;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.5);padding:16px;max-width:1100px;width:min(96vw,1100px);max-height:90vh;display:flex;flex-direction:column;gap:10px}.ency-hd{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}.filters{display:flex;gap:8px;flex-wrap:wrap}.filters .fbtn{cursor:pointer;border:1px solid #2b3a86;background:#0c1230;color:#cfe3ff;border-radius:10px;padding:8px 10px}.filters .fbtn.active{outline:2px solid var(--accent)}.ency-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(176px,1fr));gap:16px;overflow:auto;padding:12px;border:1px dashed #31408b;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0))}.ency-card{width:176px;min-height:240px;overflow:visible}.ency-card .art{min-height:88px;font-size:48px} .ency-card .name{-webkit-line-clamp:2}.ency-card:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 16px 30px rgba(0,0,0,.45),0 0 0 2px rgba(124,196,255,.15) inset} .ency-card:hover{transform:scale(1.04);z-index:3;box-shadow:0 16px 30px rgba(0,0,0,.45),0 0 0 2px rgba(124,196,255,.15) inset}.ency-card.tilted{transform:rotateX(var(--rX)) rotateY(var(--rY)) scale(1.06)}.ency-card::before{content:"";position:absolute;inset:-1px;border-radius:inherit;background:conic-gradient(from 0deg at var(--mx) var(--my), #7cc4ff66, #ffd16666, #a5b4fc66, #4ade8066, #fb718566, #7cc4ff66);filter:blur(10px) saturate(1.05);mix-blend-mode:color-dodge;opacity:0;transition:opacity .2s ease}.ency-card::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(160px 160px at var(--mx) var(--my), rgba(255,255,255,.18), transparent 40%);opacity:0;transition:opacity .2s ease}.ency-card.tilted::before{opacity:.25}.ency-card.tilted::after{opacity:.2}.ency-card .head{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}.ency-card .name{font-weight:800;font-size:14px;white-space:normal;overflow:visible;text-overflow:clip;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.ency-card .mini{font-size:12px;color:var(--muted)}.ency-card .art{display:grid;place-items:center;font-size:56px;height:auto;min-height:0;align-self:center}.ency-card .details{position:absolute;left:6px;right:6px;bottom:6px;border-radius:12px;background:#0e1435;border:1px solid #25306a;padding:8px;opacity:0;transform:translateY(8px);transition:opacity .18s ease,transform .18s ease}.ency-card:hover .details{opacity:1;transform:translateY(0)}.chip{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;margin-right:6px;border:1px solid rgba(255,255,255,.12);white-space:nowrap}.chip[data-type=keyword]{background:linear-gradient(180deg,#6342b6,#3b1f7e)}.chip[data-type=etb]{background:linear-gradient(180deg,#7c5a21,#5a3f10)}.chip[data-type=trait]{background:linear-gradient(180deg,#1a2a54,#121d40)} .chip[data-tip], .keyword[data-tip]{position:relative}
.chip[data-tip]::after, .keyword[data-tip]::after{content:attr(data-tip);position:absolute;left:50%;bottom:100%;transform:translate(-50%,-8px);background:#0e1435;border:1px solid #2b3a86;border-radius:10px;padding:10px 12px;box-shadow:0 12px 30px rgba(0,0,0,.45);font-size:12px;line-height:1.4;color:#cfe3ff;max-width:280px;min-width:180px;white-space:normal;text-align:center;opacity:0;pointer-events:none;z-index:50;transition:opacity .15s ease,transform .15s ease;will-change:opacity,transform}
.chip[data-tip]:hover::after, .keyword[data-tip]:hover::after{opacity:1;transform:translate(-50%,-10px)}
.stance-chooser{position:fixed;z-index:1000;background:#0c1230;border:1px solid #2b3a86;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.5);padding:8px;display:flex;gap:8px} .row{display:grid;grid-template-columns:80px 1fr 80px;align-items:center;gap:12px}@media (max-width:720px){.board{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));padding:16px 10px;min-height:180px}.card{width:150px}.cost{width:20px;height:20px}.name{font-size:13px}.tribe{font-size:11px}}@media (max-width:480px){.hud{grid-template-columns:1fr;gap:8px}.center-hud{flex-wrap:wrap;justify-content:space-between}}#playerBoard .card,#aiBoard .card{width:150px;min-height:220px}.board .card .art{font-size:44px}#playerBoard .card .art,#aiBoard .card .art{min-height:72px;font-size:40px}.card.blocked .cost{background:radial-gradient(circle at 30% 30%,#ffc2c2,#ff4d6d);color:#24040a}
/* deck-specific backgrounds */
.card .bg.bg-default{background:radial-gradient(140% 100% at 50% 0%,rgba(255,255,255,.04),rgba(0,0,0,0))}
.card .bg.bg-vikings{background:radial-gradient(140% 120% at 0% 0%,rgba(255,214,102,.18),transparent 40%),linear-gradient(180deg,#1a2550,#0f183a)}
.card .bg.bg-animais{background:radial-gradient(140% 120% at 0% 0%,rgba(77,185,120,.22),transparent 40%),linear-gradient(180deg,#0f2b1d,#0b1620)}
.card .bg.bg-pescadores{background:radial-gradient(140% 120% at 0% 0%,rgba(124,196,255,.25),transparent 40%),linear-gradient(180deg,#0a2a4f,#081a32)}
.card .bg.bg-floresta{background:radial-gradient(140% 120% at 0% 0%,rgba(90,190,120,.22),transparent 40%),linear-gradient(180deg,#0f2c1b,#091a14)}
.card .bg.bg-custom{background:radial-gradient(140% 120% at 0% 0%,rgba(165,180,252,.18),transparent 40%),linear-gradient(180deg,#1a1a3f,#101028)}
.ency-card.bg-vikings{background:linear-gradient(180deg,#1a2550,#0f183a)}
.ency-card.bg-animais{background:linear-gradient(180deg,#0f2b1d,#0b1620)}
.ency-card.bg-pescadores{background:linear-gradient(180deg,#0a2a4f,#081a32)}
.ency-card.bg-floresta{background:linear-gradient(180deg,#0f2c1b,#091a14)}
.ency-card.bg-custom{background:linear-gradient(180deg,#1a1a3f,#101028)}
.brand .logo-wordmark{width:min(92vw,520px);height:auto;display:block}
</style></head><body><div class="start" id="start"><div class="panel"><div class="brand">
  <svg class="logo-wordmark" viewBox="0 0 520 64" xmlns="http://www.w3.org/2000/svg" aria-label="Farm Fight Formula logo">
    <defs>
      <linearGradient id="mono" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#7cc4ff"/>
        <stop offset=".5" stop-color="#a5b4fc"/>
        <stop offset="1" stop-color="#ffd166"/>
      </linearGradient>
    </defs>
    <g transform="translate(8,6)" stroke="url(#mono)" stroke-width="9" stroke-linecap="round" fill="none">
      <path d="M38 10H20v30"/>
      <path d="M78 10H48v30"/>
      <path d="M118 10H88v30"/>
    </g>
    <g transform="translate(140,14)" font-family="Inter, ui-sans-serif">
      <text x="0" y="24" font-size="30" font-weight="800" fill="#e6e9ff">Farm Fight Formula</text>
      <text x="0" y="44" font-size="14" fill="#a7b0d9">monstros vs fazendeiros vikings</text>
    </g>
  </svg>
</div><p class="sub">Escolha um deck e parta para a arena.</p><div class="deckpick"><button class="btn deckbtn" data-deck="vikings">👩‍🌾 Fazendeiros Vikings<div class="ribbon">Cura e proteção</div><span class="view-cards" data-deck="vikings" data-tip="Ver cartas" aria-label="Ver cartas">📖</span></button><button class="btn deckbtn" data-deck="animais">🐺 Bestas do Norte<div class="ribbon">Ataque bruto</div><span class="view-cards" data-deck="animais" data-tip="Ver cartas" aria-label="Ver cartas">📖</span></button><button class="btn deckbtn" data-deck="pescadores">🎣 Pescadores do Fiorde<div class="ribbon">Suporte e bônus</div><span class="view-cards" data-deck="pescadores" data-tip="Ver cartas" aria-label="Ver cartas">📖</span></button><button class="btn deckbtn" data-deck="floresta">🌲 Feras da Floresta<div class="ribbon">Pressão constante</div><span class="view-cards" data-deck="floresta" data-tip="Ver cartas" aria-label="Ver cartas">📖</span></button><button class="btn deckbtn" data-deck="custom">🧩 Deck Personalizado<div class="ribbon">Monte seu baralho</div><span class="view-cards" data-deck="custom" data-tip="Ver cartas" aria-label="Ver cartas">📖</span></button></div><div class="footer"><span class="sub" style="margin:0">Dicas: Clique numa carta da mão para jogar e escolha <b>Ataque</b> ou <b>Defesa</b>. Em <b>Defesa</b>, o oponente deve focá-la.</span><div><button class="btn" id="openEncy">Enciclopédia</button><button class="btn" id="startGame">Jogar</button></div></div></div></div><div class="ency" id="ency"><div class="panel"><div class="ency-hd"><h2 style="margin:0">Enciclopédia de Cartas</h2><div class="filters" id="encyFilters"><button class="fbtn active" data-deck="all">Todos</button><button class="fbtn" data-deck="vikings">Vikings</button><button class="fbtn" data-deck="animais">Animais</button><button class="fbtn" data-deck="pescadores">Pescadores</button><button class="fbtn" data-deck="floresta">Floresta</button></div></div><div class="ency-grid" id="encyGrid"></div><div class="footer"><span class="sub" style="margin:0">Passe o mouse sobre uma palavra‑chave para ver o que ela faz.</span><button class="btn-ghost" id="closeEncy">Fechar</button></div></div></div><div class="wrap"><h1>FFF Farm Fight Formula</h1><div class="hud"><div class="meter"><b>Seu HP</b><span class="value" id="playerHP">30</span><div class="bar"><div class="fill" id="barPlayerHP"></div></div></div><div class="center-hud"><div class="meter mana"><b>Mana</b><span class="value" id="mana">0/0</span><div class="bar"><div class="fill" id="barMana"></div></div></div><button class="btn" id="endTurnBtn">Encerrar turno</button><button class="btn-ghost" id="muteBtn" title="Som">🔊 Som</button></div><div class="meter enemy" style="justify-self:end"><b>HP Inimigo</b><span class="value" id="aiHP">30</span><div class="enemy-img" id="aiAvatar">🧿</div><div class="bar"><div class="fill" id="barAiHP"></div></div></div></div><div class="zone-title">Tabuleiro do Inimigo</div><div class="board" id="aiBoard"></div><div class="zone-title">Seu Tabuleiro</div>
<div class="row">
  <div class="pile" id="drawPile"><span>🂠</span><div class="count" id="drawCount">0</div></div>
  <div class="board" id="playerBoard"></div>
  <div class="pile" id="discardPile"><span>🗂️</span><div class="count" id="discardCount">0</div></div>
</div>

<div class="zone-title">Sua Mão</div><div class="hand" id="playerHand"></div><div class="zone-title">Registro</div><div class="log" id="log"></div><div class="footer"><div class="face">👤 Você <span class="gem hp" id="playerHP2">30</span></div><div class="face">🧿 Inimigo <span class="gem hp" id="aiHP2">30</span></div></div></div><div class="end-overlay" id="endOverlay"><div class="end-box"><div class="end-msg" id="endMsg"></div><div class="end-sub" id="endSub"></div><div class="end-actions"><button class="btn" id="playAgainBtn">Jogar de novo</button><button class="btn" id="rematchBtn">Revanche</button><button class="btn-ghost" id="menuBtn">Menu inicial</button></div></div></div><script>(function(){const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));const logBox=$('#log');const log=t=>{if(!logBox)return;const d=document.createElement('div');d.textContent=t;logBox.prepend(d)};const rand=a=>a[Math.floor(Math.random()*a.length)],clamp=(v,a,b)=>Math.max(a,Math.min(b,v)),uid=()=>(Math.random().toString(36).slice(2));
const AudioCtx=window.AudioContext||window.webkitAudioContext;let actx=null,master=null,muted=false;function initAudio(){if(!AudioCtx)return;if(!actx){actx=new AudioCtx();master=actx.createGain();master.gain.value=.18;master.connect(actx.destination)}}function ensureRunning(){if(actx&&actx.state==='suspended')actx.resume()}function tone(f=440,d=.1,t='sine',v=1,w=0){if(!actx||muted)return;ensureRunning();const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.setValueAtTime(f,actx.currentTime+w);g.gain.setValueAtTime(.0001,actx.currentTime+w);g.gain.exponentialRampToValueAtTime(Math.max(.0002,v),actx.currentTime+w+.01);g.gain.exponentialRampToValueAtTime(.0001,actx.currentTime+w+d);o.connect(g);g.connect(master);o.start(actx.currentTime+w);o.stop(actx.currentTime+w+d+.02)}function sfx(n){if(!actx||muted)return;({start:()=>{tone(520,.08,'triangle',.7,0);tone(780,.09,'triangle',.6,.08)},play:()=>{tone(420,.07,'sine',.7,0);tone(560,.08,'sine',.6,.06)},defense:()=>{tone(280,.09,'square',.6,0);tone(200,.12,'sine',.5,.08)},attack:()=>{tone(300,.06,'sawtooth',.7,0);tone(220,.06,'sawtooth',.6,.05)},hit:()=>{tone(160,.07,'square',.6,0)},overflow:()=>{tone(600,.1,'triangle',.6,0)},death:()=>{tone(420,.08,'sawtooth',.6,0);tone(260,.12,'sawtooth',.55,.06)},end:()=>{tone(600,.06,'triangle',.6,0);tone(400,.06,'triangle',.5,.05)},crit:()=>{tone(120,.08,'square',.75,0);tone(90,.12,'square',.7,.06)},error:()=>{tone(140,.05,'square',.6,0);tone(140,.05,'square',.6,.06)}}[n]||(()=>{}))()}
// --- MENU MUSIC (procedural, deck-themed) ---
let musicGain=null,musicLoopId=null,musicOn=false,musicPreset='menu';
const MUSIC={menu:{bpm:84,leadBase:196,bassBase:98,leadWave:'triangle',bassWave:'sine',scale:[0,3,5,7,5,3,0,-5]},vikings:{bpm:76,leadBase:174.61,bassBase:87.31,leadWave:'sawtooth',bassWave:'sine',scale:[0,3,5,7,10,7,5,3]},animais:{bpm:90,leadBase:220,bassBase:110,leadWave:'square',bassWave:'sine',scale:[0,2,5,7,9,7,5,2]},pescadores:{bpm:96,leadBase:196,bassBase:98,leadWave:'triangle',bassWave:'triangle',scale:[0,2,4,7,9,7,4,2]},floresta:{bpm:68,leadBase:207.65,bassBase:103.83,leadWave:'sine',bassWave:'sine',scale:[0,3,5,10,5,3,0,-2]},combat:{bpm:118,leadBase:220,bassBase:110,leadWave:'sawtooth',bassWave:'square',scale:[0,2,3,5,7,8,7,5],perc:true,ac:4}};
function startMenuMusic(preset){if(!AudioCtx||muted)return;initAudio();ensureRunning();if(preset&&preset!==musicPreset&&musicOn){stopMenuMusic()}musicPreset=preset||musicPreset||'menu';if(musicOn)return;musicOn=true;const P=MUSIC[musicPreset]||MUSIC.menu;musicGain=actx.createGain();musicGain.gain.value=.0001;musicGain.connect(master);const tgt=musicPreset==='combat'?.22:.18;musicGain.gain.exponentialRampToValueAtTime(tgt,actx.currentTime+.4);const beat=60/P.bpm,steps=P.scale.length;const schedule=()=>{if(!musicOn||!musicGain) return; let t=actx.currentTime;for(let i=0;i<steps;i++){const f=P.leadBase*Math.pow(2,P.scale[i]/12),o=actx.createOscillator(),g=actx.createGain();o.type=P.leadWave;o.frequency.setValueAtTime(f,t+i*beat);g.gain.setValueAtTime(.0001,t+i*beat);g.gain.exponentialRampToValueAtTime(musicPreset==='combat'?.13:.11,t+i*beat+.01);g.gain.exponentialRampToValueAtTime(.0001,t+i*beat+beat*.92);o.connect(g);g.connect(musicGain);o.start(t+i*beat);o.stop(t+i*beat+beat)}for(let i=0;i<steps;i+=2){const o=actx.createOscillator(),g=actx.createGain();o.type=P.bassWave;o.frequency.setValueAtTime(P.bassBase,t+i*beat);g.gain.setValueAtTime(.0001,t+i*beat);g.gain.exponentialRampToValueAtTime(musicPreset==='combat'?.1:.09,t+i*beat+.01);g.gain.exponentialRampToValueAtTime(.0001,t+i*beat+beat*.96);o.connect(g);g.connect(musicGain);o.start(t+i*beat);o.stop(t+i*beat+beat)}if(P.perc){for(let i=0;i<steps;i++){const h=actx.createOscillator(),hg=actx.createGain();h.type='square';h.frequency.setValueAtTime(1600,t+i*beat);hg.gain.setValueAtTime(.0001,t+i*beat);hg.gain.exponentialRampToValueAtTime(.07,t+i*beat+.005);hg.gain.exponentialRampToValueAtTime(.0001,t+i*beat+beat*.2);h.connect(hg);hg.connect(musicGain);h.start(t+i*beat);h.stop(t+i*beat+beat*.2);if(P.ac&&i%P.ac===0){const k=actx.createOscillator(),kg=actx.createGain();k.type='sine';k.frequency.setValueAtTime(120,t+i*beat);kg.gain.setValueAtTime(.0001,t+i*beat);kg.gain.exponentialRampToValueAtTime(.12,t+i*beat+.01);kg.gain.exponentialRampToValueAtTime(.0001,t+i*beat+beat*.3);k.connect(kg);kg.connect(musicGain);k.start(t+i*beat);k.stop(t+i*beat+beat*.3)}}}};schedule();const loopMs=beat*steps*1000;musicLoopId=setInterval(schedule,loopMs-25)}
function stopMenuMusic(){if(!musicOn)return;musicOn=false;if(musicLoopId){clearInterval(musicLoopId);musicLoopId=null}if(musicGain){try{musicGain.gain.exponentialRampToValueAtTime(.0001,actx.currentTime+.25)}catch(e){}setTimeout(()=>{try{musicGain.disconnect()}catch(e){}musicGain=null},300)}}
function tryStartMenuMusicImmediate(){if(!AudioCtx)return;initAudio();try{ensureRunning()}catch(e){}try{startMenuMusic('menu')}catch(e){}if(actx&&actx.state!=='running'){try{actx.resume().then(()=>startMenuMusic('menu')).catch(()=>{})}catch(e){}}if(!musicOn){let tries=0;const t=setInterval(()=>{tries++;if(musicOn||tries>8){clearInterval(t);return}try{initAudio();ensureRunning();startMenuMusic('menu')}catch(e){}},800)}}

const KW={P:'Protetor',F:'Furioso'},BC={D1:'draw1',H2:'heal2',P1:'ping1',BR1:'buffRandom1',BA1:'buffAlliesAtk1'};const makeCard=a=>{const[n,e,t,atk,hp,cost,tx,k=0,b=0]=a;return{name:n,emoji:e,tribe:t,atk,hp,cost,text:tx,kw:k?k.split('|').map(x=>KW[x]):[],battlecry:b?BC[b]:void 0,id:uid()}};const TEMPLATES={vikings:[['Lavrador de Lança','🧔‍🌾','Viking',2,2,2,'Disciplinado'],['Camponesa Curandeira','👩‍🌾✨','Viking',2,3,3,'Entra: cura 2','', 'H2'],['Ceifeiro Berserker','👨‍🌾⚔️','Viking',5,2,4,'Furioso','F'],['Escudeiro Rural','🛡️','Viking',0,3,1,'Protetor','P'],['Guardião da Aldeia','🛡️🌾','Viking',3,5,4,'Protetor','P'],['Caçador de Lobos','🏹','Viking',3,2,2,'Entra: dano 1 aleatório','', 'P1'],['Ferreiro Rural','🔨','Viking',4,6,5,'Entra: +1/+1 aleatório','', 'BR1'],['Chefe da Colheita','👑🌾','Viking',5,6,6,'Aliados +1 ATK','', 'BA1']],animais:[['Urso Pardo','🐻','Animal',6,6,5,'Protetor','P'],['Lobo Cinzento','🐺','Animal',4,2,3,'Furioso','F'],['Javali Selvagem','🐗','Animal',3,2,2,'Impulsivo'],['Cervo Nobre','🦌','Animal',4,5,4,'Resistente'],['Coruja Sábia','🦉','Animal',1,2,1,'Entra: compre 1','', 'D1'],['Cavalo de Guerra','🐴','Animal',3,3,3,'Confiável'],['Cabra da Montanha','🐐','Animal',2,3,2,'Protetor','P'],['Águia do Norte','🦅','Animal',5,3,4,'Veloz'],['Urso Polar','🐻‍❄️','Animal',7,7,6,'Gigante'],['Serpente do Mar','🐍','Animal',8,7,7,'Colosso']],pescadores:[['Grumete do Fiorde','👦🎣','Viking',1,1,1,'Aprendiz'],['Pescador do Fiorde','🧔‍♂️🎣','Viking',2,3,2,'Veterano'],['Arpoador Nórdico','🪝','Viking',3,2,2,'Entra: dano 1 aleatório','', 'P1'],['Curandeira do Sal','🧂✨','Viking',2,3,3,'Entra: cura 2','', 'H2'],['Vigia do Farol','🗼🛡️','Viking',2,5,4,'Protetor','P'],['Ferreiro Naval','⚓️🔨','Viking',4,5,5,'Entra: +1/+1 aleatório','', 'BR1'],['Capitão da Pesca','👑🎣','Viking',5,6,6,'Aliados +1 ATK','', 'BA1'],['Remador Ágil','🚣','Viking',4,2,3,'Furioso','F']],floresta:[['Urso Negro','🐻','Animal',5,5,5,'Protetor','P'],['Lobo da Mata','🐺','Animal',4,2,3,'Furioso','F'],['Javali da Floresta','🐗','Animal',3,2,2,'Impulsivo'],['Cervo Vermelho','🦌','Animal',4,5,4,'Resistente'],['Coruja Sábia','🦉','Animal',1,2,1,'Entra: compre 1','', 'D1'],['Raposa Ágil','🦊','Animal',3,3,3,'Veloz'],['Bisonte das Colinas','🐂','Animal',6,6,6,'Imponente'],['Serpente do Bosque','🐍','Animal',5,4,4,'Silenciosa']]};const HUMAN=['vikings','pescadores'],BEAST=['animais','floresta'];
const G={playerHP:30,aiHP:30,turn:1,playerMana:0,playerManaCap:0,aiMana:0,aiManaCap:0,current:'player',playerDeck:[],aiDeck:[],playerHand:[],aiHand:[],playerBoard:[],aiBoard:[],playerDiscard:[],aiDiscard:[],chosen:null,playerDeckChoice:'vikings',aiDeckChoice:'animais',customDeck:null};
const els={pHP:$('#playerHP'),pHP2:$('#playerHP2'),aHP:$('#aiHP'),aHP2:$('#aiHP2'),mana:$('#mana'),pHand:$('#playerHand'),pBoard:$('#playerBoard'),aBoard:$('#aiBoard'),endBtn:$('#endTurnBtn'),muteBtn:$('#muteBtn'),aAva:$('#aiAvatar'),drawCount:$('#drawCount'),discardCount:$('#discardCount'),barPHP:$('#barPlayerHP'),barAHP:$('#barAiHP'),barMana:$('#barMana'),start:$('#start'),openEncy:$('#openEncy'),ency:$('#ency'),encyGrid:$('#encyGrid'),encyFilters:$('#encyFilters'),closeEncy:$('#closeEncy'),startGame:$('#startGame'),endOverlay:$('#endOverlay'),endMsg:$('#endMsg'),endSub:$('#endSub'),playAgainBtn:$('#playAgainBtn'),rematchBtn:$('#rematchBtn'),menuBtn:$('#menuBtn')};
// deck builder DOM (may be null if builder UI not present)
const poolEl=$('#pool'), chosenEl=$('#chosen'), countEl=$('#countDeck'), curveEl=$('#curve');
// safe builder functions (no-ops if UI not present)
function renderPool(){const all=[...TEMPLATES.vikings,...TEMPLATES.animais,...TEMPLATES.pescadores,...TEMPLATES.floresta];if(!poolEl)return;poolEl.innerHTML='';all.forEach(raw=>{const row=document.createElement('div');row.className='pitem';row.innerHTML=`<span class="c">${raw[5]}</span><div>${raw[1]} ${raw[0]}</div><button class="add">+</button>`;row.querySelector('.add').onclick=()=>{if(!G.customDeck)G.customDeck=[];if(G.customDeck.length>=20)return;const c=makeCard(raw);G.customDeck.push(c);renderChosen();updateCurve()};poolEl.appendChild(row)})}
function renderChosen(){if(!chosenEl||!countEl)return;chosenEl.innerHTML='';const list=(G.customDeck||[]);list.forEach((c,i)=>{const item=document.createElement('div');item.className='chitem';item.dataset.idx=i;item.innerHTML=`<div>${c.emoji} ${c.name} <small>(${c.cost})</small></div><button class="rm">remover</button>`;item.querySelector('.rm').onclick=()=>{const idx=Number(item.dataset.idx);if(idx>=0){G.customDeck.splice(idx,1);renderChosen();updateCurve()}};chosenEl.appendChild(item)});countEl.textContent=String(list.length)}
function updateCurve(){if(!curveEl)return;const list=(G.customDeck||[]);const buckets=new Array(8).fill(0);list.forEach(c=>{buckets[Math.min(c.cost,7)]++});curveEl.innerHTML='';const max=Math.max(1,Math.max(...buckets));buckets.forEach(v=>{const bar=document.createElement('div');bar.className='barc';const i=document.createElement('i');i.style.width=(v/max*100)+'%';bar.appendChild(i);curveEl.appendChild(bar)})}
// --- Global error capture ---
window.addEventListener('error',function(e){console.error('JS Error:',e.message,e.filename+':'+e.lineno);try{typeof log==='function'&&log('⚠️ '+e.message)}catch(_){}});
window.addEventListener('unhandledrejection',function(e){console.error('Unhandled Rejection:',e.reason);try{const msg=e.reason&&e.reason.message?e.reason.message:String(e.reason);typeof log==='function'&&log('⚠️ '+msg)}catch(_){}});

function tiltify(card){card.addEventListener('mousemove',e=>{const r=card.getBoundingClientRect();const mx=(e.clientX-r.left)/r.width*100,my=(e.clientY-r.top)/r.height*100;card.style.setProperty('--mx',mx+'%');card.style.setProperty('--my',my+'%');card.style.setProperty('--rY',((mx-50)/8)+'deg');card.style.setProperty('--rX',(-(my-50)/8)+'deg');card.classList.add('tilted')});card.addEventListener('mouseleave',()=>{card.classList.remove('tilted');card.style.removeProperty('--rX');card.style.removeProperty('--rY')})}
function cardNode(c,owner){const d=document.createElement('div');d.className=`card ${owner==='player'?'me':'enemy'} ${c.stance==='defense'?'defense':''}`;d.dataset.id=c.id;d.innerHTML=`<div class=\"bg bg-${c.deck||'default'}\"></div><div class=\"head\"><span class=\"cost\">${c.cost}</span><div class=\"name\">${c.name}</div>${c.stance?`<span class=\"badge ${c.stance==='defense'?'def':'atk'}\">${c.stance==='defense'?'DEFESA':'ATAQUE'}</span>`:''}</div><div class=\"tribe\">${c.tribe}</div><div class=\"art\">${c.emoji}</div><div class=\"text\">${(c.kw||[]).map(k=>`<span class='keyword' data-tip='${k==='Protetor'?'Enquanto houver Protetor ou carta em Defesa do lado do defensor, ataques devem mirá-los.':(k==='Furioso'?'Pode atacar no turno em que é jogada.':'')}' >${k}</span>`).join(' ')} ${c.text||''}</div><div class=\"stats\"><span class=\"gem atk\">⚔️ ${c.atk}</span><span class=\"gem hp ${c.hp<=2?'low':''}\">❤️ ${c.hp}</span></div>`;return d}
const hasGuard=b=>b.some(x=>x.kw.includes('Protetor')||x.stance==='defense');
function updateMeters(){const pct=(v,max)=>(max>0?Math.max(0,Math.min(100,(v/max)*100)):0);els.barPHP.style.width=pct(G.playerHP,30)+'%';els.barAHP.style.width=pct(G.aiHP,30)+'%';els.barMana.style.width=pct(G.playerMana,G.playerManaCap)+'%'}
function renderAll(){els.pHP.textContent=G.playerHP;els.pHP2.textContent=G.playerHP;els.aHP.textContent=G.aiHP;els.aHP2.textContent=G.aiHP;els.mana.textContent=`${G.playerMana}/${G.playerManaCap}`;els.endBtn.disabled=G.current!=='player';els.drawCount.textContent=G.playerDeck.length;els.discardCount.textContent=G.playerDiscard.length;updateMeters();renderHand();renderBoard()}
function renderHand(){els.pHand.innerHTML='';G.playerHand.forEach(c=>{const d=cardNode(c,'player');tiltify(d);d.classList.add('handcard');d.addEventListener('click',e=>{const blocked=(c.cost>G.playerMana)||G.current!=='player'||G.playerBoard.length>=5;if(blocked){d.style.transform='translateY(-2px)';setTimeout(()=>d.style.transform='',150);sfx('error');return}e.stopPropagation();openStanceChooser(d,st=>flyToBoard(d,()=>playFromHand(c.id,st)))});const cantPay=(c.cost>G.playerMana);const disable=(G.current!=='player'||G.playerBoard.length>=5);d.classList.toggle('blocked',cantPay);d.style.opacity=(cantPay||disable)?0.9:1;d.style.cursor=(cantPay||disable)?'not-allowed':'pointer';els.pHand.appendChild(d)})}
function renderBoard(){validateChosen();els.pBoard.innerHTML='';for(const c of G.playerBoard){const d=cardNode(c,'player');tiltify(d);if(G.current==='player'&&c.canAttack&&c.stance!=='defense'){d.classList.add('selectable');d.addEventListener('click',()=>selectAttacker(c))}els.pBoard.appendChild(d)}els.aBoard.innerHTML='';for(const c of G.aiBoard){const d=cardNode(c,'ai');tiltify(d);if(G.chosen){if(legalTarget('ai',c)){d.classList.add('selectable');d.addEventListener('click',()=>attackCard(G.chosen,c))}}els.aBoard.appendChild(d)}let btn=document.querySelector('#aiBoard .face-attack-btn');if(!btn){btn=document.createElement('button');btn.type='button';btn.className='btn-ghost face-attack-btn';btn.textContent='🗡️ Atacar diretamente';Object.assign(btn.style,{position:'absolute',top:'8px',right:'8px',display:'none'});btn.addEventListener('click',()=>{if(G.chosen)attackFace(G.chosen,'ai')});els.aBoard.appendChild(btn)}updateFaceAttackZone()}
function openStanceChooser(anchor,cb){closeStanceChooser();const r=anchor.getBoundingClientRect(),box=document.createElement('div');box.className='stance-chooser';Object.assign(box.style,{left:Math.max(8,r.left+r.width/2-120)+'px',top:Math.max(8,r.top-48)+'px'});const bA=document.createElement('button');bA.className='btn';bA.textContent='⚔️ Ataque';const bD=document.createElement('button');bD.className='btn';bD.textContent='🛡️ Defesa';bA.onclick=()=>{closeStanceChooser();cb('attack')};bD.onclick=()=>{closeStanceChooser();cb('defense')};box.append(bA,bD);document.body.appendChild(box);setTimeout(()=>{const h=ev=>{if(ev.target.closest('.stance-chooser'))return;window.removeEventListener('click',h,true);closeStanceChooser()};window.addEventListener('click',h,true);bA.focus()},0)}const closeStanceChooser=()=>{const old=document.querySelector('.stance-chooser');old&&old.remove()}
function flyToBoard(node,onEnd){const r=node.getBoundingClientRect(),clone=node.cloneNode(true);Object.assign(clone.style,{left:r.left+'px',top:r.top+'px',width:r.width+'px',height:r.height+'px',position:'fixed',zIndex:999,transition:'transform .45s ease,opacity .45s ease'});clone.classList.add('fly');document.body.appendChild(clone);const br=els.pBoard.getBoundingClientRect();requestAnimationFrame(()=>{const tx=br.left+br.width/2-r.left-r.width/2,ty=br.top+10-r.top;clone.style.transform=`translate(${tx}px,${ty}px) scale(.9)`;clone.style.opacity='0'});setTimeout(()=>{clone.remove();onEnd&&onEnd()},450)}
function startGame(){const sanitize=c=>{if(c.hp<1)c.hp=1;if(c.atk<0)c.atk=0;return c};G.playerDeck=(G.playerDeckChoice==='custom'&&G.customDeck?shuffle(G.customDeck.slice()):TEMPLATES[G.playerDeckChoice].map(makeCard));G.playerDeck.forEach(c=>{sanitize(c);c.owner='player';c.deck=(G.playerDeckChoice==='custom'?'custom':G.playerDeckChoice)});G.aiDeck=TEMPLATES[G.aiDeckChoice].map(makeCard);G.aiDeck.forEach(c=>{sanitize(c);c.owner='ai';c.deck=G.aiDeckChoice});G.playerDiscard=[];G.aiDiscard=[];G.playerHand=[];G.aiHand=[];G.playerBoard=[];G.aiBoard=[];G.playerHP=30;G.aiHP=30;G.current='player';G.playerMana=0;G.playerManaCap=0;G.aiMana=0;G.aiManaCap=0;draw('player',3);draw('ai',3);newTurn();renderAll();stopMenuMusic();startMenuMusic('combat');log('A batalha começou!');sfx('start')}
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
function draw(who,n=1){const deck=who==='player'?G.playerDeck:G.aiDeck,hand=who==='player'?G.playerHand:G.aiHand,disc=who==='player'?G.playerDiscard:G.aiDiscard;for(let i=0;i<n;i++){if(deck.length===0&&disc.length){deck.push(...shuffle(disc.splice(0)))}if(deck.length){const c=deck.shift();if(c.hp<1)c.hp=1;hand.push(c)}}if(who==='player'){els.drawCount.textContent=G.playerDeck.length;els.discardCount.textContent=G.playerDiscard.length}}
function newTurn(){if(G.current==='player'){G.playerManaCap=clamp(G.playerManaCap+1,0,10);G.playerMana=G.playerManaCap;draw('player',1);G.playerBoard.forEach(c=>c.canAttack=true)}else{G.aiManaCap=clamp(G.aiManaCap+1,0,10);G.aiMana=G.aiManaCap;draw('ai',1);G.aiBoard.forEach(c=>c.canAttack=true)}renderAll()}
function endTurn(){if(G.current!=='player')return;G.current='ai';G.chosen=null;updateTargetingUI();newTurn();sfx('end');setTimeout(aiTurn,500)}
function playFromHand(id,st){if(G.current!=='player')return;const i=G.playerHand.findIndex(c=>c.id===id);if(i<0)return;const c=G.playerHand[i];if(c.cost>G.playerMana||G.playerBoard.length>=5)return;G.playerHand.splice(i,1);summon('player',c,st);G.playerMana-=c.cost;renderAll();sfx(st==='defense'?'defense':'play')}
function summon(side,c,st='attack'){const board=side==='player'?G.playerBoard:G.aiBoard;c.stance=st;c.canAttack=(st==='attack')&&c.kw.includes('Furioso');board.push(c);log(`${side==='player'?'Você':'Inimigo'} jogou ${c.name} em modo ${st==='defense'?'defesa':'ataque'}.`);triggerBattlecry(side,c);if(st==='defense')setTimeout(()=>animateDefense(c.id),30)}
function triggerBattlecry(side,c){const foe=side==='player'?'ai':'player';switch(c.battlecry){case 'draw1':draw(side,1);log(`${c.name}: comprou 1 carta.`);break;case 'heal2':{const allies=(side==='player'?G.playerBoard:G.aiBoard);if(allies.length){const t=rand(allies);t.hp=Math.min(t.hp+2,20);fxTextOnCard(t.id,'+2','heal');log(`${c.name}: curou 2 em ${t.name}.`)}}break;case 'ping1':{const foes=(foe==='ai'?G.aiBoard:G.playerBoard);if(foes.length){const t=rand(foes);damageMinion(t,1);fxTextOnCard(t.id,'-1','dmg');log(`${c.name}: 1 de dano em ${t.name}.`);checkDeaths();renderAll();sfx('hit')}}break;case 'buffRandom1':{const allies=(side==='player'?G.playerBoard:G.aiBoard).filter(x=>x.id!==c.id);if(allies.length){const t=rand(allies);t.atk+=1;t.hp+=1;fxTextOnCard(t.id,'+1/+1','buff');log(`${c.name}: deu +1/+1 em ${t.name}.`)}}break;case 'buffAlliesAtk1':{const allies=(side==='player'?G.playerBoard:G.aiBoard).filter(x=>x.id!==c.id);allies.forEach(x=>{x.atk+=1;fxTextOnCard(x.id,'+1 ATK','buff')});if(allies.length)log(`${c.name}: aliados ganharam +1 de ataque.`)}break;}}
function updateTargetingUI(){document.body.classList.toggle('targeting',!!G.chosen)}
function validateChosen(){
  if(!G.chosen) return false;
  if(G.current!=='player'){
    G.chosen=null; document.body.classList.remove('targeting');
    return false;
  }
  const ref=G.playerBoard.find(x=>x.id===G.chosen.id);
  if(!ref || !ref.canAttack || ref.stance==='defense'){
    G.chosen=null; document.body.classList.remove('targeting');
    return false;
  }
  G.chosen=ref; // normalize reference
  return true;
}
function cancelTargeting(){if(!G.chosen)return;G.chosen=null;updateTargetingUI();els.aBoard.classList.remove('face-can-attack');renderBoard()}
function selectAttacker(c){if(G.current!=='player'||!c.canAttack||c.stance==='defense')return;G.chosen=c;updateTargetingUI();renderBoard();updateFaceAttackZone();G.aiBoard.filter(x=>x.stance==='defense').forEach(x=>setTimeout(()=>animateDefense(x.id),20))}
function updateFaceAttackZone(){
  const guard=hasGuard(G.aiBoard), valid=validateChosen();
  const canFace = valid && !guard;
  const btn=document.querySelector('#aiBoard .face-attack-btn');
  if(canFace){
    els.aBoard.classList.add('face-can-attack');
    btn&&(btn.style.display='block');
  }else{
    els.aBoard.classList.remove('face-can-attack');
    btn&&(btn.style.display='none');
  }
}
function legalTarget(side,target){const b=side==='ai'?G.aiBoard:G.playerBoard;return hasGuard(b)?(target.kw.includes('Protetor')||target.stance==='defense'):true}
const nodeById=id=>document.querySelector(`.card[data-id=\"${id}\"]`);const addAnim=(n,c,d=400)=>{n&&n.classList.add(c);setTimeout(()=>n&&n.classList.remove(c),d)};const animateAttack=(aId,tId)=>{const a=nodeById(aId),t=tId?nodeById(tId):null;addAnim(a,'attack-lunge',350);if(t)addAnim(t,'hit-shake',350)};const animateDefense=id=>{const n=nodeById(id);addAnim(n,'shield-flash',600)};function screenSlash(x,y,ang){const fx=document.createElement('div');fx.className='fx fx-slash';fx.style.left=x+'px';fx.style.top=y+'px';fx.style.setProperty('--ang',ang+'deg');document.body.appendChild(fx);setTimeout(()=>fx.remove(),380)}
function fxTextOnCard(cid,text,cls){const n=document.querySelector(`.card[data-id="${cid}"]`);if(!n)return;const r=n.getBoundingClientRect();const fx=document.createElement('div');fx.className='fx-float '+(cls||'');fx.textContent=text;fx.style.left=(r.left+r.width/2)+'px';fx.style.top=(r.top+r.height/2)+'px';document.body.appendChild(fx);setTimeout(()=>fx.remove(),950);}
function attackCard(attacker,target){if(!attacker||!attacker.canAttack||attacker.stance==='defense')return;sfx('attack');const a=nodeById(attacker.id),t=nodeById(target.id);if(a&&t){const ar=a.getBoundingClientRect(),tr=t.getBoundingClientRect();screenSlash(ar.right,ar.top+ar.height/2,15)}animateAttack(attacker.id,target.id);if(target.stance==='defense')animateDefense(target.id);const pre=target.hp,overflow=Math.max(0,attacker.atk-pre);damageMinion(target,attacker.atk);damageMinion(attacker,target.atk);sfx('hit');if(overflow>0&&target.hp<=0){const isP=G.playerBoard.includes(attacker);if(isP){G.aiHP=clamp(G.aiHP-overflow,0,99);log(`${attacker.name} excedeu em ${overflow} e causou dano direto ao Inimigo!`)}else{G.playerHP=clamp(G.playerHP-overflow,0,99);log(`${attacker.name} excedeu em ${overflow} e causou dano direto a Você!`)}checkWin()}attacker.canAttack=false;log(`${attacker.name} atacou ${target.name}.`);checkDeaths();renderAll();G.chosen=null;updateTargetingUI();els.aBoard.classList.remove('face-can-attack')}
function attackFace(attacker,face){if(!attacker||!attacker.canAttack||attacker.stance==='defense')return;sfx('attack');const a=nodeById(attacker.id);if(a){const ar=a.getBoundingClientRect();screenSlash(ar.right,ar.top+ar.height/2,10)}animateAttack(attacker.id,null);const dmg=attacker.atk;attacker.canAttack=false;if(face==='ai'){G.aiHP=clamp(G.aiHP-dmg,0,99);log(`${attacker.name} causou ${dmg} ao Inimigo!`);sfx('crit')}else{G.playerHP=clamp(G.playerHP-dmg,0,99);log(`${attacker.name} causou ${dmg} a Você!`);sfx('hit')}checkWin();G.chosen=null;updateTargetingUI();els.aBoard.classList.remove('face-can-attack');renderAll()}
function damageMinion(m,amt){if(!m||typeof amt!=='number')return;m.hp=clamp(m.hp-amt,0,99);if(m.hp<=0) setTimeout(checkDeaths,10)}
function checkDeaths(){const deadA=G.aiBoard.filter(c=>c.hp<=0);if(deadA.length){G.aiBoard=G.aiBoard.filter(c=>c.hp>0);G.aiDiscard.push(...deadA);log('Uma criatura inimiga caiu.')}const deadP=G.playerBoard.filter(c=>c.hp<=0);if(deadP.length){G.playerBoard=G.playerBoard.filter(c=>c.hp>0);G.playerDiscard.push(...deadP);log('Sua criatura caiu.')}els.discardCount.textContent=G.playerDiscard.length}
function aiTurn(){const playable=G.aiHand.filter(c=>c.cost<=G.aiMana).sort((a,b)=>b.cost-a.cost);while(playable.length&&G.aiBoard.length<5&&G.aiMana>0){const c=playable.shift();const i=G.aiHand.findIndex(x=>x.id===c.id);if(i>-1&&c.cost<=G.aiMana){G.aiHand.splice(i,1);const stance=(c.hp>=c.atk+1)?(Math.random()<.7?'defense':'attack'):(Math.random()<.3?'defense':'attack');summon('ai',c,stance);G.aiMana-=c.cost}}renderAll();const attackers=G.aiBoard.filter(c=>c.canAttack&&c.stance!=='defense');function next(){if(!attackers.length){G.current='player';newTurn();return}const a=attackers.shift();const legal=G.playerBoard.filter(x=>legalTarget('player',x));if(legal.length){attackCard(a,rand(legal))}else{attackFace(a,'player')}setTimeout(next,500)}setTimeout(next,500)}
function fireworks(win){const b=document.createElement('div');b.className='boom';b.style.left='50%';b.style.top='50%';b.style.background=`radial-gradient(circle at 50% 50%, ${win?'#8bf5a2':'#ff8a8a'}, transparent)`;document.body.appendChild(b);setTimeout(()=>b.remove(),650);} 
function endGame(win){stopMenuMusic();els.endMsg.textContent=win?'You WIN!':'You Lose...';els.endMsg.style.color=win?'#8bf5a2':'#ff8a8a';els.endSub.textContent=win?'Parabéns! Quer continuar jogando?':'Tentar de novo ou voltar ao menu.';els.endOverlay.classList.add('show');setTimeout(()=>fireworks(win),1000);} 
function checkWin(){if(G.aiHP<=0){endGame(true)}if(G.playerHP<=0){endGame(false)}}
function allCards(){let out=[];for(const k of Object.keys(TEMPLATES)){for(const raw of TEMPLATES[k]){const c=makeCard(raw);c.deck=k;out.push(c)}}return out}
function renderEncy(filter='all',locked=false){els.encyGrid.innerHTML='';const cards=(filter==='all'?allCards():TEMPLATES[filter].map(makeCard).map(c=>Object.assign(c,{deck:filter})));cards.forEach(c=>{const d=document.createElement('div');d.className=`card ency-card bg-${c.deck}`;d.innerHTML=`<div class='bg bg-${c.deck}'></div><div class='head'><span class='cost'>${c.cost}</span><div class='name'>${c.name}</div></div><div class='mini'>${c.tribe} • ⚔️ ${c.atk} / ❤️ ${c.hp}</div><div class='art'>${c.emoji}</div><div class='details'><div>${(c.kw||[]).map(k=>`<span class='chip' data-type='keyword' data-tip='${k==='Protetor'?'Enquanto houver Protetor ou carta em Defesa do lado do defensor, ataques devem mirá-los.':(k==='Furioso'?'Pode atacar no turno em que é jogada.':'')}' >${k}</span>`).join(' ')}</div><div style='margin-top:6px'>${c.text||''}</div></div>`;tiltify(d);els.encyGrid.appendChild(d)});els.ency.classList.add('show');els.encyFilters.style.display=locked?'none':'flex';$$('.filters .fbtn').forEach(b=>b.classList.toggle('active',b.dataset.deck===filter||filter==='all'&&b.dataset.deck==='all'))}
els.endBtn.addEventListener('click',endTurn);els.muteBtn.addEventListener('click',()=>{initAudio();ensureRunning();muted=!muted;if(master) master.gain.value=muted?0:.18; if(musicGain) musicGain.gain.value=muted?0:.18; els.muteBtn.textContent=muted?'🔇 Mudo':'🔊 Som'});window.addEventListener('keydown',e=>{if(e.key==='Escape')cancelTargeting()});document.addEventListener('click',e=>{if(!G.chosen)return;if(e.target.closest('#aiBoard .card.selectable')||e.target.closest('#playerBoard .card.selectable')||e.target.closest('#aiBoard .face-attack-btn'))return;cancelTargeting()},{capture:true});
$$('.deckbtn').forEach(btn=>{btn.addEventListener('pointermove',e=>{const r=btn.getBoundingClientRect();btn.style.setProperty('--px',((e.clientX-r.left)/r.width*100)+'%');btn.style.setProperty('--py',((e.clientY-r.top)/r.height*100)+'%')});btn.addEventListener('mouseenter',()=>{btn.style.setProperty('--halo',.7);btn.style.setProperty('--shine',.7)});btn.addEventListener('mouseleave',()=>{btn.style.removeProperty('--halo');btn.style.removeProperty('--shine')});btn.addEventListener('click',()=>{const pick=btn.dataset.deck;G.playerDeckChoice=pick;if(HUMAN.includes(pick)){G.aiDeckChoice=rand(BEAST)} else {G.aiDeckChoice=rand(HUMAN)} startMenuMusic(pick); $$('.deckbtn').forEach(b=>b.style.outline='none');btn.style.outline='2px solid var(--accent)'});const book=btn.querySelector('.view-cards');book&&book.addEventListener('click',ev=>{ev.stopPropagation();renderEncy(btn.dataset.deck,true)})});
els.startGame.addEventListener('click',()=>{els.start.style.display='none';initAudio();ensureRunning();stopMenuMusic();startGame()});
els.openEncy.addEventListener('click',()=>renderEncy('all',false));els.closeEncy.addEventListener('click',()=>{els.ency.classList.remove('show')});$$('.filters .fbtn').forEach(b=>b.addEventListener('click',()=>{renderEncy(b.dataset.deck,false)}));
els.playAgainBtn.addEventListener('click',()=>{els.endOverlay.classList.remove('show');startGame()});els.rematchBtn.addEventListener('click',()=>{els.endOverlay.classList.remove('show');startGame()});els.menuBtn.addEventListener('click',()=>{els.endOverlay.classList.remove('show');els.start.style.display='grid';startMenuMusic('menu')});
document.addEventListener('DOMContentLoaded',tryStartMenuMusicImmediate);
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible')tryStartMenuMusicImmediate()});
window.addEventListener('pointerdown',()=>{initAudio();ensureRunning();startMenuMusic('menu')},{once:true});
})();</script>
